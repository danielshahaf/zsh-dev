#!/usr/bin/env zsh
set -e

local NAME=$0

usage() {
  cat >&2 <<EOF
$NAME: a zsh developer's git-am wrapper script

Usage: $NAME FILE...

Where each FILE is a zsh-workers@ message generated by git-format-patch(1) or
git-send-email(1), will apply each such patch using git-am(1) and then add
the X-Seq number to the log message and changelog using 'zshdev-add-nnnnn-and-changelog'.

NOTE: zsh-users@ messages are not currently detected or handled correctly.

Prerequisite: git must have been compiled with PCRE support.
EOF
  exit ${1:-1}
}

# This script takes filenames of emails, extracts the X-Seq headers therefrom,
# applies them with 'git am', and readies them for pushing by calling
# zshdev-add-nnnnn-and-changelog.

if [[ $1 == -* ]]; then
  usage
fi

for arg; do
  git am $arg
  if xseq=$(<$arg sed -n -e 's/^X-Seq: //p' -e '/^$/q' )
     [[ -n $xseq ]] 
  then
    zshdev-add-nnnnn-and-changelog $xseq
  else
    echo >&2 "$0: failed to parse X-Seq from $arg"
    exit 1
    break
  fi
done
tig "@{u}.." # review the results
